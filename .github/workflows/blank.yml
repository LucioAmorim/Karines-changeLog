name: Generate Changelog from PR Descriptions

on:
  workflow_dispatch:
    inputs:
      base_branches:
        description: "Branches base para buscar PRs mesclados (separadas por vírgula)"
        required: true
        default: "master,main"
      output_file:
        description: "Arquivo de changelog"
        required: true
        default: "CHANGELOG.md"
      max_prs:
        description: "Número máximo de PRs a incluir"
        required: true
        default: "100"

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog content
        uses: actions/github-script@v7
        env:
          BASE_BRANCHES: ${{ inputs.base_branches }}
          OUTPUT_FILE: ${{ inputs.output_file }}
          MAX_PRS: ${{ inputs.max_prs }}
        with:
          script: |
            const fs = require('fs');

            const baseBranches = (process.env.BASE_BRANCHES || '')
              .split(',')
              .map(item => item.trim())
              .filter(Boolean);
            const outputFile = process.env.OUTPUT_FILE;
            const maxPrs = Number(process.env.MAX_PRS || 100);

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const baseQuery = baseBranches.length
              ? baseBranches.map(branch => `base:${branch}`).join(' OR ')
              : '';

            const query = `repo:${owner}/${repo} is:pr is:merged ${baseQuery}`.trim();

            const search = async () => {
              const items = [];
              let page = 1;
              const perPage = 100;

              while (items.length < maxPrs) {
                const { data } = await github.rest.search.issuesAndPullRequests({
                  q: query,
                  per_page: perPage,
                  page
                });

                if (!data.items.length) break;

                items.push(...data.items);
                if (data.items.length < perPage) break;
                page += 1;
              }

              return items.slice(0, maxPrs);
            };

            const cleanBody = (body = '') => {
              return body
                .replace(/<!--[\s\S]*?-->/g, '')
                .replace(/\r\n/g, '\n')
                .trim();
            };

            const formatBody = (body) => {
              if (!body) return [];
              return body.split('\n').map(line => `  > ${line}`);
            };

            const prs = await search();

            if (!prs.length) {
              core.warning('Nenhum PR mesclado encontrado.');
              return;
            }

            const detailed = [];
            for (const item of prs) {
              const { data: pr } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: item.number
              });

              detailed.push({
                number: pr.number,
                title: pr.title,
                url: pr.html_url,
                user: pr.user?.login || 'unknown',
                body: cleanBody(pr.body || '')
              });
            }

            const today = new Date().toISOString().split('T')[0];
            const lines = [];
            lines.push(`## ${today}`);
            lines.push('');

            for (const pr of detailed) {
              lines.push(`- [#${pr.number}](${pr.url}) ${pr.title} (@${pr.user})`);
              if (pr.body) {
                lines.push('  - Descrição:');
                lines.push(...formatBody(pr.body));
              }
              lines.push('');
            }

            const section = lines.join('\n').trimEnd() + '\n\n';
            const header = '# Changelog\n\n';

            let existing = '';
            if (fs.existsSync(outputFile)) {
              existing = fs.readFileSync(outputFile, 'utf8');
            }

            if (!existing.startsWith('# Changelog')) {
              existing = header + existing.trimStart();
            }

            const updated = existing.replace(header, header + section);
            fs.writeFileSync(outputFile, updated, 'utf8');

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: atualizar changelog"
          title: "docs: atualizar changelog"
          body: "CHANGELOG gerado automaticamente a partir das descrições dos PRs."
          branch: "automation/changelog-pr-body-${{ github.run_id }}"
          delete-branch: true
          labels: "documentation"