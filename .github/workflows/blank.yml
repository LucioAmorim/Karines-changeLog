name: Generate Changelog from PR Descriptions

on:
  workflow_dispatch:
    inputs:
      base_branches:
        description: "Branches base para buscar PRs mesclados (separadas por vírgula)"
        required: true
        default: "master,main"
      output_file:
        description: "Arquivo de changelog"
        required: true
        default: "CHANGELOG.md"
      max_prs:
        description: "Número máximo de PRs a incluir"
        required: true
        default: "100"

permissions:
  contents: write
  pull-requests: read

jobs:
  generate-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog content
        uses: actions/github-script@v7
        env:
          BASE_BRANCHES: ${{ inputs.base_branches }}
          OUTPUT_FILE: ${{ inputs.output_file }}
          MAX_PRS: ${{ inputs.max_prs }}
        with:
          script: |
            const fs = require('fs');

            const baseBranches = (process.env.BASE_BRANCHES || '')
              .split(',')
              .map(item => item.trim())
              .filter(Boolean);
            const outputFile = process.env.OUTPUT_FILE;
            const maxPrs = Number(process.env.MAX_PRS || 100);

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const fallbackBranches = ['master', 'main'];
            const branches = baseBranches.length ? baseBranches : fallbackBranches;

            const listMerged = async (base) => {
              const params = {
                owner,
                repo,
                state: 'closed',
                per_page: 100,
                ...(base ? { base } : {})
              };

              const prs = await github.paginate(github.rest.pulls.list, params);
              return prs.filter(pr => pr.merged_at);
            };

            const cleanBody = (body = '') => {
              return body
                .replace(/<!--[\s\S]*?-->/g, '')
                .replace(/\r\n/g, '\n')
                .trim();
            };

            const formatBody = (body) => {
              if (!body) return [];
              return body.split('\n').map(line => `  > ${line}`);
            };

            let prs = [];

            for (const base of branches) {
              const merged = await listMerged(base);
              prs.push(...merged);
            }

            if (!prs.length) {
              prs = await listMerged();
            }

            const seen = new Set();
            prs = prs
              .filter(pr => {
                if (seen.has(pr.number)) return false;
                seen.add(pr.number);
                return true;
              })
              .slice(0, maxPrs);

            if (!prs.length) {
              core.warning('Nenhum PR mesclado encontrado.');
              return;
            }

            const detailed = [];
            for (const pr of prs) {
              detailed.push({
                number: pr.number,
                title: pr.title,
                url: pr.html_url,
                user: pr.user?.login || 'unknown',
                body: cleanBody(pr.body || '')
              });
            }

            const today = new Date().toISOString().split('T')[0];
            const lines = [];
            lines.push(`## ${today}`);
            lines.push('');

            for (const pr of detailed) {
              lines.push(`- [#${pr.number}](${pr.url}) ${pr.title} (@${pr.user})`);
              if (pr.body) {
                lines.push('  - Descrição:');
                lines.push(...formatBody(pr.body));
              }
              lines.push('');
            }

            const section = lines.join('\n').trimEnd() + '\n\n';
            const header = '# Changelog\n\n';

            let existing = '';
            if (fs.existsSync(outputFile)) {
              existing = fs.readFileSync(outputFile, 'utf8');
            }

            if (!existing.startsWith('# Changelog')) {
              existing = header + existing.trimStart();
            }

            const updated = existing.replace(header, header + section);
            fs.writeFileSync(outputFile, updated, 'utf8');

      - name: Create PR
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "docs: atualizar changelog"
          title: "docs: atualizar changelog"
          body: "CHANGELOG gerado automaticamente a partir das descrições dos PRs."
          branch: "automation/changelog-pr-body-${{ github.run_id }}"
          delete-branch: true
          labels: "documentation"